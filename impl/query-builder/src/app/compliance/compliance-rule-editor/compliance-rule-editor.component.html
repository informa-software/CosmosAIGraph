<div class="compliance-rule-editor-container" (click)="closeAllDropdowns()">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h2>{{ mode === 'create' ? 'Create New Rule' : 'Edit Rule' }}</h2>
      <p class="subtitle">
        {{ mode === 'create' ? 'Define a new compliance rule for contract evaluation' : 'Update compliance rule details' }}
      </p>
    </div>
    <div class="header-right">
      <button class="btn btn-outline" (click)="cancel()">
        <i class="icon-close"></i> Cancel
      </button>
      <button
        class="btn btn-primary"
        (click)="saveRule()"
        [disabled]="saving || loading"
      >
        <i class="icon-save"></i>
        {{ saving ? 'Saving...' : (mode === 'create' ? 'Create Rule' : 'Save Changes') }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading rule details...</p>
  </div>

  <!-- Form -->
  <div *ngIf="!loading" class="form-container">
    <form>
      <!-- Rule Name -->
      <div class="form-group">
        <label for="rule-name" class="form-label required">Rule Name</label>
        <input
          id="rule-name"
          type="text"
          class="form-input"
          [(ngModel)]="formData.name"
          name="name"
          placeholder="Enter a clear, concise rule name"
          [class.error]="formErrors.name"
          maxlength="200"
        />
        <div class="field-info">
          <span class="char-count">{{ getNameCharCount() }}</span>
          <span *ngIf="formErrors.name" class="error-message">{{ formErrors.name }}</span>
        </div>
        <p class="field-hint">
          A short, descriptive name that clearly identifies the rule (e.g., "Payment Terms Must Be 30 Days or Less")
        </p>
      </div>

      <!-- Rule Description -->
      <div class="form-group">
        <label for="rule-description" class="form-label required">Rule Description</label>
        <textarea
          id="rule-description"
          class="form-textarea"
          [(ngModel)]="formData.description"
          name="description"
          placeholder="Describe what the rule checks and why it's important"
          [class.error]="formErrors.description"
          rows="5"
          maxlength="1000"
        ></textarea>
        <div class="field-info">
          <span class="char-count">{{ getDescriptionCharCount() }}</span>
          <span *ngIf="formErrors.description" class="error-message">{{ formErrors.description }}</span>
        </div>
        <p class="field-hint">
          Detailed explanation of the rule, including what constitutes compliance and non-compliance
        </p>
      </div>

      <!-- Severity -->
      <div class="form-group">
        <label for="rule-severity" class="form-label required">Severity Level</label>
        <select
          id="rule-severity"
          class="form-select"
          [(ngModel)]="formData.severity"
          name="severity"
          [class.error]="formErrors.severity"
        >
          <option value="" disabled>Select severity level</option>
          <option *ngFor="let sev of SEVERITY_OPTIONS" [value]="sev.value">
            {{ sev.label }}
          </option>
        </select>
        <span *ngIf="formErrors.severity" class="error-message">{{ formErrors.severity }}</span>
        <p class="field-hint">
          The impact level if this rule is violated
        </p>

        <!-- Severity Preview -->
        <div *ngIf="formData.severity" class="severity-preview">
          <span>Preview:</span>
          <span class="badge badge-{{ getSeverityColor(formData.severity) }}">
            {{ formData.severity }}
          </span>
        </div>
      </div>

      <!-- Category -->
      <div class="form-group">
        <label for="rule-category" class="form-label required">Category</label>
        <div class="category-input-group">
          <select
            id="rule-category"
            class="form-select"
            [(ngModel)]="formData.category"
            name="category"
            [class.error]="formErrors.category"
          >
            <option value="" disabled>Select a category</option>
            <option *ngFor="let cat of categories" [value]="cat.name">
              {{ cat.display_name }}
            </option>
          </select>
          <button
            type="button"
            class="btn btn-outline btn-sm"
            (click)="createNewCategory()"
            title="Create new category"
          >
            <i class="icon-plus"></i> New Category
          </button>
        </div>
        <span *ngIf="formErrors.category" class="error-message">{{ formErrors.category }}</span>

        <!-- Category Description -->
        <div *ngIf="formData.category" class="category-description">
          <p>{{ getCategoryDescription(formData.category) }}</p>
        </div>
      </div>

      <!-- Rule Sets -->
      <div class="form-group">
        <label class="form-label">Rule Sets (Optional)</label>
        <p class="field-hint">
          Select which rule sets this rule belongs to. Rules can belong to multiple sets.
        </p>
        <div class="dropdown" [class.open]="ruleSetDropdownOpen">
          <button
            type="button"
            class="btn-dropdown"
            (click)="toggleRuleSetDropdown($event)"
          >
            {{ selectedRuleSetIds.length > 0 ? selectedRuleSetIds.length + ' selected' : 'No rule sets selected' }}
            <span class="dropdown-arrow">â–¼</span>
          </button>
          <div class="dropdown-content" (click)="$event.stopPropagation()">
            <div *ngIf="ruleSets.length === 0" class="empty-message">
              <p>No rule sets available. <a [routerLink]="['/compliance/rule-sets']">Create a rule set</a></p>
            </div>
            <div *ngFor="let ruleSet of ruleSets" class="checkbox-item">
              <input
                type="checkbox"
                [checked]="isRuleSetSelected(ruleSet.id)"
                (change)="toggleRuleSet(ruleSet.id, $event)"
              />
              <label>{{ ruleSet.name }} ({{ ruleSet.rule_ids?.length || 0 }} rules)</label>
            </div>
          </div>
        </div>
        <div class="selected-badges" *ngIf="selectedRuleSetIds.length > 0">
          <span *ngFor="let ruleSetId of selectedRuleSetIds" class="badge">
            {{ getRuleSetName(ruleSetId) }}
          </span>
        </div>
      </div>

      <!-- Active Status -->
      <div class="form-group">
        <label class="form-label">Status</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="formData.active"
              name="active"
            />
            <span class="checkbox-text">
              <strong>Active</strong> - This rule will be evaluated on new contracts
            </span>
          </label>
        </div>
        <p class="field-hint">
          Inactive rules are not evaluated but remain available for future use
        </p>
      </div>

      <!-- Form Actions (Repeated at Bottom) -->
      <div class="form-actions">
        <button
          type="button"
          class="btn btn-outline"
          (click)="cancel()"
          [disabled]="saving"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="saveRule()"
          [disabled]="saving || loading"
        >
          <i class="icon-save"></i>
          {{ saving ? 'Saving...' : (mode === 'create' ? 'Create Rule' : 'Save Changes') }}
        </button>
      </div>
    </form>
  </div>

  <!-- Metadata (Edit Mode Only) -->
  <div *ngIf="!loading && mode === 'edit' && originalRule" class="metadata-section">
    <h3>Rule Metadata</h3>
    <div class="metadata-grid">
      <div class="metadata-item">
        <span class="metadata-label">Rule ID:</span>
        <span class="metadata-value">{{ originalRule.id }}</span>
      </div>
      <div class="metadata-item">
        <span class="metadata-label">Created Date:</span>
        <span class="metadata-value">{{ formatDate(originalRule.created_date) }}</span>
      </div>
      <div class="metadata-item">
        <span class="metadata-label">Created By:</span>
        <span class="metadata-value">{{ originalRule.created_by }}</span>
      </div>
      <div class="metadata-item">
        <span class="metadata-label">Last Updated:</span>
        <span class="metadata-value">{{ formatDate(originalRule.updated_date) }}</span>
      </div>
    </div>
  </div>
</div>
