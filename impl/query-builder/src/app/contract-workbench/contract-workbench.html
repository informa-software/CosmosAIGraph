<div class="contract-workbench">
  <!-- Header -->
  <header class="workbench-header">
    <div class="header-content">
      <div class="title-section">
        <h1>{{ pageIcon }} {{ pageTitle }}</h1>
      </div>
      <div class="search-section">
        <div class="search-input-group">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            [(ngModel)]="searchText"
            placeholder="Search text inside clauses..."
            class="search-input">
          <button (click)="copyResults()" class="btn btn-secondary">
            üìã Copy
          </button>
          <!-- Job Monitor Badge Button -->
          <button (click)="toggleJobMonitor()" class="btn btn-job-monitor" [class.has-active-jobs]="activeJobCount > 0">
            <span class="job-icon">‚öôÔ∏è</span>
            <span class="job-label">Jobs</span>
            <span class="job-badge" *ngIf="activeJobCount > 0">{{ activeJobCount }}</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="workbench-container">
    <!-- Left Sidebar -->
    <aside class="sidebar left-sidebar">
      <!-- Generate Comparison Controls -->
      <div class="card" *ngIf="workbenchMode === 'comparison'">
        <div class="card-header">
          <h3>üìä Comparison Criteria</h3>
        </div>
        <div class="card-body">
          <!-- Standard Contract Selection -->
          <div class="form-group">
            <label>
              Standard Contract
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip">Select a contract to use as the comparison standard</span>
              </span>
            </label>
            <select [(ngModel)]="standardContractId" (ngModelChange)="onStandardContractChange()" class="form-control">
              <option value="">Select a standard contract...</option>
              <option *ngFor="let contract of allContracts" [ngValue]="contract.id">
                {{ contract.title }}
              </option>
            </select>
          </div>

          <div class="section-separator">
            <hr>
            <span class="separator-label">Compare With</span>
          </div>

          <!-- Contract Type -->
          <div class="form-group">
            <label>Contract Type</label>
            <select [(ngModel)]="filters.type" (ngModelChange)="onContractTypeChange()" class="form-control">
              <option value="Any">Any</option>
              <option *ngFor="let type of availableContractTypes" [value]="type.normalizedName">
                {{ type.displayName }}
              </option>
            </select>
          </div>

          <!-- Contracting Party -->
          <div class="form-group">
            <label>
              Contracting Party
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip">Select the Party initiating the Contract</span>
              </span>
            </label>
            <div class="dropdown">
              <button class="btn btn-secondary full-width dropdown-toggle">
                {{ filters.contractingParties && filters.contractingParties.length > 0 ? filters.contractingParties.length + ' selected' : 'Any' }}
              </button>
              <div class="dropdown-content">
                <small class="help-text">Select the Party initiating the Contract</small>
                <div class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="!filters.contractingParties || filters.contractingParties.length === 0"
                    (change)="toggleContractingParty('Any')">
                  <label>Any</label>
                </div>
                <div *ngFor="let party of availableContractingParties" class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="isContractingPartySelected(party.normalizedName)"
                    (change)="toggleContractingParty(party.normalizedName)">
                  <label>{{ party.displayName }}</label>
                </div>
              </div>
            </div>
            <div class="selected-items">
              <span *ngFor="let party of filters.contractingParties" class="badge badge-secondary">
                {{ getContractingPartyDisplayName(party) }}
              </span>
            </div>
          </div>

          <!-- Effective Date Range -->
          <div class="form-group">
            <label>
              Effective Date
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip">Optional: Select a date range for the Contract Effective Date</span>
              </span>
            </label>
            <div class="date-range">
              <div class="date-input">
                <label>From</label>
                <input type="date" [(ngModel)]="filters.dateFrom" (ngModelChange)="validateDateRange()" class="form-control">
              </div>
              <div class="date-input">
                <label>To</label>
                <input type="date" [(ngModel)]="filters.dateTo" (ngModelChange)="validateDateRange()" class="form-control">
              </div>
            </div>
            <small *ngIf="dateRangeError" class="warning-text">
              {{ dateRangeError }}
            </small>
          </div>

          <!-- Governing Law -->
          <div class="form-group">
            <label>
              Governing Law
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip">Select contracts governed by specific laws</span>
              </span>
            </label>
            <div class="dropdown">
              <button class="btn btn-secondary full-width dropdown-toggle">
                {{ filters.governingLaws && filters.governingLaws.length > 0 ? filters.governingLaws.length + ' selected' : 'Any' }}
              </button>
              <div class="dropdown-content">
                <small class="help-text">Select governing laws to filter contracts</small>
                <div class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="!filters.governingLaws || filters.governingLaws.length === 0"
                    (change)="toggleGoverningLaw('Any')">
                  <label>Any</label>
                </div>
                <div *ngFor="let law of availableGoverningLaws" class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="isGoverningLawSelected(law.normalizedName)"
                    (change)="toggleGoverningLaw(law.normalizedName)">
                  <label>{{ law.displayName }}</label>
                </div>
              </div>
            </div>
            <div class="selected-items">
              <span *ngFor="let law of filters.governingLaws" class="badge badge-secondary">
                {{ getGoverningLawDisplayName(law) }}
              </span>
            </div>
          </div>

          <!-- Contract Selection -->
          <div class="form-group">
            <button (click)="compareSelected()" class="btn btn-secondary full-width">
              Select Contracts <span class="badge">{{ selectedContracts.length }}</span>
            </button>
          </div>

          <!-- Comparison Mode Selector -->
          <div class="form-group">
            <label>
              Comparison Mode
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip" style="white-space: normal; width: 250px;">
                  Select if the comparison should be done at the Clause level or across the entire contract.
                </span>
              </span>
            </label>
            <div class="btn-group full-width">
              <button 
                [class.active]="filters.comparisonMode === 'clauses'"
                (click)="onComparisonModeChange('clauses')"
                class="btn btn-toggle">
                Clauses
              </button>
              <button 
                [class.active]="filters.comparisonMode === 'full'"
                (click)="onComparisonModeChange('full')"
                class="btn btn-toggle">
                Full Contract
              </button>
            </div>
          </div>

          <hr>

          <!-- Clauses -->
          <div class="form-group" *ngIf="filters.comparisonMode === 'clauses'">
            <label>
              Clauses
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip" style="white-space: normal; width: 300px;">
                  Select the clauses to compare in the standard contract against the selected contracts. Clauses in the selected contracts and not in the standard contract will be flagged.
                </span>
              </span>
            </label>
            <div *ngIf="!standardContractId" class="alert alert-info">
              Please select a Standard Contract first to see available clauses.
            </div>
            <div *ngIf="standardContractId && availableClausesFromStandard.length === 0" class="alert alert-warning">
              No clauses found in the selected standard contract.
            </div>
            <div *ngIf="standardContractId && availableClausesFromStandard.length > 0" class="dropdown">
              <button 
                class="btn btn-secondary full-width dropdown-toggle"
                [disabled]="false">
                {{ getClausesButtonText() }}
              </button>
              <div class="dropdown-content">
                <small class="help-text">Choose clauses from the standard contract to compare</small>
                <!-- All option -->
                <div class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="areAllClausesSelected()"
                    (change)="toggleAllClauses()">
                  <label><strong>All</strong></label>
                </div>
                <hr style="margin: 5px 0;">
                <!-- Individual clause options -->
                <div *ngFor="let clause of availableClausesFromStandard" class="checkbox-item">
                  <input 
                    type="checkbox"
                    [checked]="isClauseSelected(clause)"
                    (change)="toggleClause(clause)">
                  <label>{{ clause }}</label>
                </div>
              </div>
            </div>
            <div class="selected-items" *ngIf="filters.clauses.length > 0 && !areAllClausesSelected()">
              <span *ngFor="let clause of filters.clauses" class="badge badge-secondary">
                {{ clause }}
              </span>
            </div>
            <div class="selected-items" *ngIf="areAllClausesSelected()">
              <span class="badge badge-primary">All Clauses Selected</span>
            </div>
          </div>

          <!-- Risk Threshold -->
          <div class="form-group">
            <label>Risk Threshold</label>
            <input 
              type="range" 
              min="0" 
              max="100" 
              [(ngModel)]="filters.risk"
              class="range-slider">
            <small class="help-text">Show ‚â• {{ filters.risk }}% risk score</small>
          </div>

          <!-- Mode Selection -->
          <div class="form-group">
            <label>
              Processing Mode
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip" style="white-space: normal; width: 250px;">
                  Real Time: Application waits while results are processed (may take several minutes).<br><br>
                  Batch: Process executes in background and notifies when complete.
                </span>
              </span>
            </label>
            <div class="btn-group full-width">
              <button 
                [class.active]="filters.mode === 'realtime'"
                (click)="onModeChange('realtime')"
                class="btn btn-toggle">
                Real time
              </button>
              <button 
                [class.active]="filters.mode === 'batch'"
                (click)="onModeChange('batch')"
                class="btn btn-toggle">
                Batch
              </button>
            </div>
          </div>

          <!-- Generate Button -->
          <div class="form-group">
            <button 
              (click)="generateComparison()" 
              class="btn btn-primary full-width"
              [disabled]="!standardContractId || selectedContracts.length === 0">
              ‚ö° Generate Comparison
            </button>
          </div>

        </div>
      </div>

      <!-- Query Contracts Controls -->
      <div class="card" *ngIf="workbenchMode === 'question'">
        <div class="card-header">
          <h3>‚ú® Select Contracts</h3>
        </div>
        <div class="card-body">
          <!-- Context Contracts Selection -->
          <div class="form-group">
            <label>Context Contracts</label>
            <button
              (click)="openQuestionContractSelector()"
              class="btn btn-block btn-outline">
              üìÑ Select Contracts ({{ selectedContractsForQuestion.length }})
            </button>

            <!-- Token Usage Meter -->
            <div class="token-meter" *ngIf="selectedContractsForQuestion.length > 0">
              <div class="token-meter-label">
                <span>Token Usage</span>
                <span class="badge" [ngClass]="getTokenBadgeClass()">
                  {{ formatTokens(usedTokens) }} / {{ formatTokens(availableTokenBudget) }}
                </span>
              </div>
              <div class="token-meter-bar">
                <div
                  class="token-meter-fill"
                  [ngClass]="getTokenBadgeClass()"
                  [style.width.%]="tokenUsagePercentage">
                </div>
              </div>
              <small class="help-text">
                {{ formatTokens(remainingTokens) }} tokens remaining
              </small>
            </div>

            <!-- Selected Contracts List (compact) -->
            <div class="selected-contracts-compact"
                 *ngIf="selectedContractsForQuestion.length > 0">
              <div *ngFor="let contract of selectedContractsForQuestionDetails"
                   class="selected-contract-chip">
                <span class="contract-name">
                  {{ contract.title }}
                </span>
                <span class="contract-tokens">
                  {{ formatTokens(contract.text_tokens || 0) }}
                </span>
                <button
                  (click)="toggleContractForQuestion(contract.id)"
                  class="btn-remove">√ó</button>
              </div>
            </div>
          </div>

          <hr>

          <!-- Processing Mode Selection for Queries -->
          <div class="form-group">
            <label>
              Processing Mode
              <span class="info-icon-container">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span class="info-tooltip" style="white-space: normal; width: 250px;">
                  Real Time: Application waits while results are processed (streaming response).<br><br>
                  Batch: Process executes in background and notifies when complete.
                </span>
              </span>
            </label>
            <div class="btn-group full-width">
              <button
                [class.active]="filters.mode === 'realtime'"
                (click)="onModeChange('realtime')"
                class="btn btn-toggle">
                Real time
              </button>
              <button
                [class.active]="filters.mode === 'batch'"
                (click)="onModeChange('batch')"
                class="btn btn-toggle">
                Batch
              </button>
            </div>
          </div>

          <hr>

          <!-- Saved Queries -->
          <label>Saved Queries</label>
          <div class="saved-query">
            <span>Non-Delaware contracts</span>
            <button (click)="runSavedQuery('non-delaware')" class="btn btn-sm">Run</button>
          </div>
          <div class="saved-query">
            <span>Indemnity by type</span>
            <button (click)="runSavedQuery('indemnity-by-type')" class="btn btn-sm">Run</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Chat Interface Card (Only visible in question mode) -->
      <div class="card chat-card" *ngIf="workbenchMode === 'question'">
        <div class="card-header">
          <h3>üí¨ Contract Questions</h3>
          <button (click)="clearChatHistory()" class="btn btn-sm btn-secondary" *ngIf="chatHistory.length > 0">
            Clear Chat
          </button>
        </div>
        <div class="card-body chat-container">
          <!-- Chat History -->
          <div class="chat-history">
            <div *ngIf="chatHistory.length === 0" class="chat-empty-state">
              <p>Ask questions about the selected contracts using natural language.</p>
              <p class="muted">Click an example to try:</p>
              <ul>
                <li (click)="askExampleQuestion('Which of these contracts have the broadest indemnification for the contracting party?')">
                  Which of these contracts have the broadest indemnification for the contracting party?
                </li>
                <li (click)="askExampleQuestion('What are the payment terms variations across these contracts?')">
                  What are the payment terms variations across these contracts?
                </li>
                <li (click)="askExampleQuestion('Compare the financial risks to the contracting entity and rank them highest to lowest')">
                  Compare the financial risks to the contracting entity and rank them highest to lowest
                </li>
              </ul>
            </div>
            
            <div *ngFor="let message of chatHistory" class="chat-message user-message">
              <div class="message-bubble">
                {{ message.text }}
                <div *ngIf="message.isProcessing" class="processing-indicator">
                  <span class="spinner-small"></span>
                  <span>Analyzing...</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Token Limit Warning -->
          <div *ngIf="isTokenLimitExceeded && selectedContractsForQuestion.length > 0" class="alert alert-warning" style="margin: 1rem 0;">
            <strong>‚ö†Ô∏è Token Limit Exceeded</strong>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
              Your query will be processed in the background. You will be notified once the query has completed.
            </p>
          </div>

          <!-- Chat Input -->
          <div class="chat-input-container">
            <input
              type="text"
              [(ngModel)]="currentChatInput"
              (keypress)="onChatKeyPress($event)"
              placeholder="Type your question and press Enter..."
              class="chat-input"
              [disabled]="isLoadingAnswer">
            <button
              (click)="sendChatMessage()"
              class="btn btn-primary send-button"
              [disabled]="isLoadingAnswer || !currentChatInput.trim()">
              <span *ngIf="!isLoadingAnswer && !isTokenLimitExceeded">Send</span>
              <span *ngIf="!isLoadingAnswer && isTokenLimitExceeded">Submit Query</span>
              <span *ngIf="isLoadingAnswer">...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content Card -->
      <div class="card">
        <div class="card-body">
          <!-- Answers Content (Question Mode - No Tabs) -->
          <div *ngIf="workbenchMode === 'question'">
            <div class="answer-box">
              <h4>Answer</h4>

              <!-- Streaming Indicator -->
              <div *ngIf="isStreaming" class="streaming-indicator">
                <div class="spinner-container">
                  <div class="spinner"></div>
                  <span class="streaming-text">Generating response...</span>
                </div>
              </div>

              <!-- Progressive Content Display -->
              <div *ngIf="safeAnswer" [innerHTML]="safeAnswer" class="streaming-content"></div>

              <!-- Empty State -->
              <p *ngIf="!safeAnswer && !isStreaming" class="muted">
                Ask a question using the chat interface to analyze your selected contracts.
              </p>

              <!-- Timing Info (shown when complete) -->
              <div *ngIf="streamingElapsed > 0 && !isStreaming" class="timing-info">
                <small class="help-text">Response generated in {{ streamingElapsed.toFixed(1) }}s</small>
              </div>

              <!-- Action Buttons (shown when answer is available) -->
              <div *ngIf="safeAnswer && !isStreaming" class="answer-actions" style="margin-top: 1rem;">
                <div class="export-dropdown" [class.show]="showQueryExportMenu">
                  <button class="btn btn-sm btn-primary dropdown-toggle"
                          type="button"
                          (click)="showQueryExportMenu = !showQueryExportMenu"
                          [disabled]="isSavingResult || isGeneratingPDF">
                    <span *ngIf="!isSavingResult && !isGeneratingPDF">üì§ Export</span>
                    <span *ngIf="isSavingResult">üíæ Saving...</span>
                    <span *ngIf="isGeneratingPDF">üìÑ Generating PDF...</span>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right" [class.show]="showQueryExportMenu">
                    <button class="dropdown-item"
                            (click)="saveAndGenerateQueryPDF(); showQueryExportMenu = false"
                            [disabled]="isSavingResult || isGeneratingPDF">
                      üìÑ Save & Generate PDF
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item"
                            disabled
                            title="Email functionality coming soon">
                      ‚úâÔ∏è Email PDF <small class="text-muted">(Coming Soon)</small>
                    </button>
                  </div>
                </div>
              </div>

              <small class="help-text">(Generated using AI analysis of contract text)</small>
            </div>
          </div>

          <!-- Clauses Tab (for other modes if needed) -->
          <div *ngIf="activeTab === 'clauses'" class="tab-content">
            <div *ngIf="pickedContracts.length < 2" class="alert alert-info">
              Select 2+ contracts to compare clauses.
            </div>
            <div *ngIf="pickedContracts.length >= 2" class="clause-compare-grid">
              <div *ngFor="let clauseKey of CLAUSE_KEYS" class="clause-card">
                <h4>{{ getClauseIcon(clauseKey) }} {{ clauseKey }}</h4>
                <div *ngFor="let contract of pickedContracts" class="clause-content">
                  <div class="clause-header">
                    <span class="badge badge-secondary">{{ contract.id }}</span>
                    <span class="badge badge-info">{{ contract.governing_law_state }}</span>
                  </div>
                  <p class="clause-text" [innerHTML]="highlightText(contract.clauses[clauseKey])"></p>
                </div>
                <small class="help-text">Inline highlights show exact wording differences.</small>
              </div>
            </div>
            <button *ngIf="pickedContracts.length >= 2" (click)="showRawDiff()" class="btn btn-secondary">
              üîÑ Show Raw Diff
            </button>
          </div>

          <!-- Comparison Results -->
          <div *ngIf="workbenchMode === 'comparison'" class="tab-content">
            <div *ngIf="!comparisonResults && workbenchMode === 'comparison'" class="alert alert-info">
              <h4>üìä Contract Comparison</h4>
              <p>To generate a comparison:</p>
              <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>Select a Standard Contract from the left panel</li>
                <li>Choose filter criteria and select contracts to compare</li>
                <li>Choose comparison mode (Clauses or Full Contract)</li>
                <li>Click "Generate Comparison" to analyze</li>
              </ol>
            </div>
            
            <div *ngIf="comparisonResults && !comparisonResults.success" class="alert alert-danger">
              <strong>Comparison Failed:</strong> {{ comparisonResults.error || 'An error occurred during comparison.' }}
            </div>

            <div *ngIf="comparisonResults && comparisonResults.success">
              <!-- Comparison Header -->
              <div class="comparison-header">
                <div class="comparison-title-row">
                  <h4>üìä Contract Comparison Results</h4>
                  <div class="export-dropdown" [class.show]="showComparisonExportMenu">
                    <button class="btn btn-sm btn-primary dropdown-toggle"
                            type="button"
                            (click)="showComparisonExportMenu = !showComparisonExportMenu"
                            [disabled]="isSavingResult || isGeneratingPDF">
                      <span *ngIf="!isSavingResult && !isGeneratingPDF">üì§ Export</span>
                      <span *ngIf="isSavingResult">üíæ Saving...</span>
                      <span *ngIf="isGeneratingPDF">üìÑ Generating PDF...</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" [class.show]="showComparisonExportMenu">
                      <button class="dropdown-item" (click)="exportComparisonResults(); showComparisonExportMenu = false">
                        üì• Export JSON
                      </button>
                      <button class="dropdown-item"
                              (click)="saveAndGenerateComparisonPDF(); showComparisonExportMenu = false"
                              [disabled]="isSavingResult || isGeneratingPDF">
                        üìÑ Save & Generate PDF
                      </button>
                      <div class="dropdown-divider"></div>
                      <button class="dropdown-item"
                              disabled
                              title="Email functionality coming soon">
                        ‚úâÔ∏è Email PDF <small class="text-muted">(Coming Soon)</small>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="comparison-info">
                  <span class="badge badge-primary" [title]="'Standard: ' + getContractTitle(comparisonResults.standardContractId!)">
                    Standard: {{ getContractTitle(comparisonResults.standardContractId!) }}
                  </span>
                  <span class="badge badge-secondary" [title]="'Mode: ' + comparisonResults.comparisonMode">
                    Mode: {{ comparisonResults.comparisonMode }}
                  </span>
                  <span class="badge badge-info" [title]="'Compared: ' + (comparisonResults.compareContractIds?.length || 0) + ' contracts'">
                    Compared: {{ comparisonResults.compareContractIds?.length || 0 }} contracts
                  </span>
                </div>
              </div>

              <!-- Comparison Results Grid -->
              <div class="comparison-results-grid">
                <div *ngFor="let comparison of comparisonResults.results?.comparisons" class="comparison-card">
                  <div class="comparison-card-header">
                    <h5>{{ getContractTitle(comparison.contract_id) }}</h5>
                    <div class="comparison-metrics">
                      <span class="badge" [ngClass]="getSimilarityBadgeClass(comparison.overall_similarity_score * 100)">
                        {{ (comparison.overall_similarity_score * 100).toFixed(0) }}% Similar
                      </span>
                      <span class="badge" [ngClass]="getRiskBadgeClass(comparison.risk_level)">
                        {{ comparison.risk_level }} Risk
                      </span>
                    </div>
                  </div>

                  <!-- Critical Findings -->
                  <div *ngIf="comparison.critical_findings && comparison.critical_findings.length > 0" class="critical-findings">
                    <h6>üö® Critical Findings</h6>
                    <ul>
                      <li *ngFor="let finding of comparison.critical_findings">{{ finding }}</li>
                    </ul>
                  </div>

                  <!-- Missing Clauses/Provisions -->
                  <div *ngIf="comparison.missing_clauses && comparison.missing_clauses.length > 0" class="missing-clauses">
                    <h6>‚ö†Ô∏è {{ comparisonResults.comparisonMode === 'full' ? 'Missing Provisions' : 'Missing Clauses' }}</h6>
                    <small class="subtitle-text" *ngIf="comparisonResults.comparisonMode === 'full'">
                      Provisions in Standard Contract but not Comparison Contract
                    </small>
                    <div class="clause-list">
                      <span *ngFor="let clause of comparison.missing_clauses" class="badge badge-warning">
                        {{ clause }}
                      </span>
                    </div>
                  </div>

                  <!-- Additional Clauses/Provisions -->
                  <div *ngIf="comparison.additional_clauses && comparison.additional_clauses.length > 0" class="additional-clauses">
                    <h6>‚ûï {{ comparisonResults.comparisonMode === 'full' ? 'Additional Provisions' : 'Additional Clauses' }}</h6>
                    <small class="subtitle-text" *ngIf="comparisonResults.comparisonMode === 'full'">
                      Provisions in Comparison Contract but not Standard Contract
                    </small>
                    <div class="clause-list">
                      <span *ngFor="let clause of comparison.additional_clauses" class="badge badge-info">
                        {{ clause }}
                      </span>
                    </div>
                  </div>

                  <!-- Clause/Contract Analysis -->
                  <div *ngIf="comparison.clause_analyses && comparison.clause_analyses.length > 0" class="clause-analyses">
                    <h6>üìã {{ comparisonResults.comparisonMode === 'full' ? 'Contract Analysis' : 'Clause Analysis' }}</h6>
                    <div *ngFor="let analysis of getSortedClauseAnalyses(comparison.clause_analyses)" class="clause-analysis-item">
                      <div class="clause-analysis-header collapsible-header" 
                           (click)="toggleClauseExpansion(comparison.contract_id, analysis.clause_type)"
                           [class.expanded]="isClauseExpanded(comparison.contract_id, analysis.clause_type)">
                        <div class="header-content">
                          <span class="expand-icon">{{ isClauseExpanded(comparison.contract_id, analysis.clause_type) ? '‚ñº' : '‚ñ∂' }}</span>
                          <strong>{{ analysis.clause_type }}</strong>
                          <span class="badge" [ngClass]="getSimilarityBadgeClass(analysis.similarity_score * 100)">
                            {{ (analysis.similarity_score * 100).toFixed(0) }}% Match
                          </span>
                        </div>
                      </div>
                      
                      <div *ngIf="isClauseExpanded(comparison.contract_id, analysis.clause_type)" class="clause-details">
                        <div *ngIf="analysis.summary" class="clause-summary">
                          {{ analysis.summary }}
                        </div>

                        <div *ngIf="analysis.key_differences && analysis.key_differences.length > 0" class="key-differences">
                          <strong>Key Differences:</strong>
                          <ul>
                            <li *ngFor="let diff of analysis.key_differences">{{ diff }}</li>
                          </ul>
                        </div>

                        <div *ngIf="analysis.risks && analysis.risks.length > 0" class="clause-risks">
                          <strong>Risks:</strong>
                          <ul>
                            <li *ngFor="let risk of analysis.risks" class="risk-item">{{ risk }}</li>
                          </ul>
                        </div>

                        <!-- Review Clause Text Button -->
                        <div class="clause-actions">
                          <button 
                            (click)="showClauseText(analysis, comparison.contract_id)" 
                            class="btn btn-secondary btn-sm">
                            üìã Review Clause Text
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar right-sidebar">
      <!-- Graph Insights Card -->
      <div class="card">
        <div class="card-header">
          <h3>üíπ Graph Insights</h3>
        </div>
        <div class="card-body">
          <div class="insights-section">
            <h4>Top Jurisdictions</h4>
            <div class="jurisdiction-badges">
              <span *ngFor="let item of jurisdictionStats | keyvalue" class="badge badge-secondary">
                {{ item.key }} ¬∑ {{ item.value }}
              </span>
            </div>
          </div>
          <div class="insights-section">
            <h4>Entity Relationship Sketch</h4>
            <div class="under-construction-placeholder">
              <div class="construction-icon">üöß</div>
              <div class="construction-text">Under Construction</div>
              <small class="help-text">Graph visualizations coming soon</small>
            </div>
          </div>
          <small class="tip">
            Tip: Run a graph pattern to instantly answer complex queries.
          </small>
        </div>
      </div>

      <!-- Info Card -->
      <div class="card">
        <div class="card-header">
          <h3>‚ÑπÔ∏è What this UI supports</h3>
        </div>
        <div class="card-body">
          <!-- Comparison Mode Features -->
          <ul class="feature-list" *ngIf="workbenchMode === 'comparison'">
            <li>üìã Select standard contract for comparison baseline</li>
            <li>üîç Filter contracts by type, party, date, and jurisdiction</li>
            <li>‚öñÔ∏è Compare at clause level or full contract level</li>
            <li>üéØ AI-powered analysis with similarity scores & risk levels</li>
            <li>‚ö†Ô∏è Identify missing and additional provisions</li>
            <li>üìä Clause-by-clause analysis with key differences</li>
            <li>üì§ Export comparison results for review</li>
            <li>üîé Side-by-side clause text comparison</li>
          </ul>
          <!-- Question Mode Features -->
          <ul class="feature-list" *ngIf="workbenchMode === 'question'">
            <li>üí¨ Ask questions about contracts in natural language</li>
            <li>üìÑ Select specific contracts as context for queries</li>
            <li>üìä Smart token budget tracking and management</li>
            <li>ü§ñ AI-powered answers based on contract content</li>
            <li>üíæ Use saved queries for common analysis tasks</li>
            <li>üîÑ Conversational chat interface with history</li>
            <li>‚ö° Real-time or batch processing options</li>
            <li>üéØ Context-aware responses from selected contracts</li>
          </ul>
        </div>
      </div>
    </aside>
  </div>

  <!-- Job Monitor Sidebar -->
  <div class="job-monitor-sidebar" [class.show]="showJobMonitor">
    <!-- Sidebar Header -->
    <div class="job-monitor-header">
      <h3>‚öôÔ∏è Background Jobs</h3>
      <button (click)="toggleJobMonitor()" class="close-btn">‚úï</button>
    </div>

    <!-- Sidebar Content -->
    <div class="job-monitor-content">
      <!-- Empty State -->
      <div *ngIf="activeJobs.length === 0" class="job-monitor-empty">
        <div class="empty-icon">üì≠</div>
        <p>No active jobs</p>
        <small class="help-text">Background jobs will appear here when processing</small>
      </div>

      <!-- Job List -->
      <div *ngIf="activeJobs.length > 0" class="job-list">
        <div *ngFor="let job of activeJobs" class="job-card">
          <!-- Job Header -->
          <div class="job-card-header">
            <div class="job-info">
              <span class="job-type-icon">{{ getJobTypeIcon(job.job_type) }}</span>
              <span class="job-type-label">{{ getJobTypeLabel(job.job_type) }}</span>
            </div>
            <div class="job-header-actions">
              <span class="badge" [ngClass]="getJobStatusBadgeClass(job.status)">
                {{ job.status }}
              </span>
              <!-- Delete button for finished jobs -->
              <button
                *ngIf="job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled'"
                (click)="deleteJob(job.job_id)"
                class="btn-delete-job"
                title="Delete this job">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- Job Progress (only show for active jobs) -->
          <div class="job-progress-section" *ngIf="job.status === 'queued' || job.status === 'processing'">
            <div class="progress-info">
              <span class="progress-step">{{ job.progress.current_step }}</span>
              <span class="progress-percentage">{{ job.progress.percentage.toFixed(0) }}%</span>
            </div>
            <div class="progress-bar-container">
              <div
                class="progress-bar-fill"
                [ngClass]="getJobStatusBadgeClass(job.status)"
                [style.width.%]="job.progress.percentage">
              </div>
            </div>
            <small class="progress-message" *ngIf="job.progress.message">
              {{ job.progress.message }}
            </small>
          </div>

          <!-- Job Actions -->
          <div class="job-actions">
            <!-- Cancel Button -->
            <button
              *ngIf="canCancelJob(job.status)"
              (click)="cancelJob(job.job_id)"
              class="btn btn-sm btn-warning"
              title="Cancel this job">
              üö´ Cancel
            </button>

            <!-- Retry Button -->
            <button
              *ngIf="job.status === 'failed'"
              (click)="retryJob(job.job_id)"
              class="btn btn-sm btn-primary"
              title="Retry this job">
              üîÑ Retry
            </button>

            <!-- View Results Button -->
            <button
              *ngIf="job.status === 'completed' && job.result_id"
              (click)="viewJobResult(job.result_id, job.job_type)"
              class="btn btn-sm btn-success"
              title="View results">
              üëÅÔ∏è View
            </button>

            <!-- Error Details Button -->
            <button
              *ngIf="job.status === 'failed' && job.progress.error"
              (click)="showJobError(job)"
              class="btn btn-sm btn-danger"
              title="View error details">
              ‚ö†Ô∏è Details
            </button>
          </div>

          <!-- Job Metadata -->
          <div class="job-metadata">
            <!-- Show creation date for all jobs -->
            <small class="help-text">
              <strong>Created:</strong> {{ formatJobTimestamp(job.created_date) }}
            </small>

            <!-- Show completion date for completed/failed/cancelled jobs -->
            <small class="help-text" *ngIf="job.completed_date && (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled')">
              <strong>Finished:</strong> {{ formatJobTimestamp(job.completed_date) }}
            </small>

            <!-- Show elapsed time for completed jobs -->
            <small class="help-text" *ngIf="job.elapsed_time && (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled')">
              <strong>Duration:</strong> {{ formatElapsedTime(job.elapsed_time) }}
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Monitor Backdrop -->
  <div
    *ngIf="showJobMonitor"
    class="job-monitor-backdrop"
    (click)="toggleJobMonitor()">
  </div>

  <!-- Contract Selection Modal -->
  <div *ngIf="showContractSelectionModal" class="modal" (click)="closeContractSelectionModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ workbenchMode === 'question' ? 'Select Contracts for Query' : 'Contract Selection' }}</h3>
        <button (click)="closeContractSelectionModal()" class="close-btn">‚úï</button>
      </div>

      <!-- Token Budget Subheader (Question Mode Only) -->
      <div *ngIf="workbenchMode === 'question'" class="modal-subheader">
        <div class="token-budget-display">
          <div class="budget-info">
            <span class="budget-label">Token Budget:</span>
            <span class="budget-values">
              <span class="used-tokens" [ngClass]="getTokenBadgeClass()">
                {{ formatTokens(usedTokens) }}
              </span>
              <span class="separator">/</span>
              <span class="total-tokens">{{ formatTokens(availableTokenBudget) }}</span>
            </span>
          </div>
          <div class="token-budget-bar">
            <div
              class="token-budget-fill"
              [ngClass]="getTokenBadgeClass()"
              [style.width.%]="tokenUsagePercentage">
            </div>
          </div>
          <div class="budget-details">
            <span class="remaining">{{ formatTokens(remainingTokens) }} remaining</span>
            <span class="percentage">{{ tokenUsagePercentage.toFixed(1) }}% used</span>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div *ngIf="isLoadingContracts" class="loading-container">
          <div class="spinner"></div>
          <p>Loading contracts...</p>
        </div>
        <div *ngIf="!isLoadingContracts">
          <!-- Token Limit Warning -->
          <div *ngIf="workbenchMode === 'question' && isTokenLimitExceeded && selectedContractsForQuestion.length > 0"
               class="alert alert-warning" style="margin-bottom: 1rem;">
            <strong>‚ö†Ô∏è Token Limit Exceeded</strong>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
              Your query will be processed in the background. You will be notified once the query has completed.
            </p>
          </div>
          <div class="modal-controls">
            <div class="search-input-wrapper">
              <input
                type="text"
                [(ngModel)]="modalSearchText"
                (input)="updateFilteredContracts()"
                placeholder="Search contracts..."
                class="form-control modal-search">
              <button
                *ngIf="modalSearchText"
                (click)="clearModalSearch()"
                class="search-clear-btn"
                title="Clear search">‚úï</button>
            </div>
            <button *ngIf="workbenchMode === 'comparison'" (click)="selectAllContracts()" class="btn btn-sm">Select All</button>
            <button (click)="workbenchMode === 'question' ? clearQuestionContracts() : deselectAllContracts()" class="btn btn-sm">
              {{ workbenchMode === 'question' ? 'Clear Selection' : 'Deselect All' }}
            </button>
            <div class="flex-spacer"></div>
            <span class="badge badge-secondary">
              {{ workbenchMode === 'question' ? selectedContractsForQuestion.length : selectedContracts.length }} selected
            </span>
          </div>
          <div class="contract-list">
            <div *ngFor="let contract of getFilteredContractsForSelection()"
                 class="contract-item">
              <input
                type="checkbox"
                [checked]="workbenchMode === 'question' ? isContractSelectedForQuestion(contract.id) : isContractSelected(contract.id)"
                (change)="workbenchMode === 'question' ? toggleContractForQuestion(contract.id) : toggleContractSelection(contract.id)"
                [id]="'contract-check-' + contract.id">
              <label [for]="'contract-check-' + contract.id">
                <strong>{{ contract.title }}</strong>
                <div class="contract-info">
                  <span class="badges">
                    <span class="badge badge-secondary">{{ contract.contract_type }}</span>
                    <span class="badge badge-info">{{ contract.governing_law_state }}</span>
                    <span class="badge badge-primary">{{ contract.effective_date }}</span>
                    <span *ngIf="workbenchMode === 'question' && contract.text_tokens"
                          class="badge token-badge"
                          [ngClass]="getContractTokenBadgeClass(contract.text_tokens)">
                      üìä {{ formatTokens(contract.text_tokens) }}
                    </span>
                  </span>
                </div>
                <button class="pdf-icon-btn" (click)="viewContractPdf(contract.id); $event.stopPropagation()" title="View PDF">
                  üìÑ
                </button>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button *ngIf="workbenchMode === 'question'"
                (click)="closeContractSelectionModal()"
                class="btn btn-primary"
                [disabled]="selectedContractsForQuestion.length === 0">
          Use {{ selectedContractsForQuestion.length }} Contract{{ selectedContractsForQuestion.length !== 1 ? 's' : '' }}
        </button>
        <button (click)="closeContractSelectionModal()" class="btn btn-secondary">
          {{ workbenchMode === 'question' ? 'Cancel' : 'Close' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Contract Details Modal -->
  <div *ngIf="showContractDetailsModal && selectedContractForDetails" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>{{ selectedContractForDetails.title }}</h3>
        <div class="modal-header-actions">
          <button (click)="evaluateContract(selectedContractForDetails.id)" class="btn btn-primary" title="Evaluate this contract for compliance">
            üîç Evaluate Compliance
          </button>
          <button (click)="viewContractPdf(selectedContractForDetails.id)" class="btn btn-primary" title="Open PDF in new tab">
            üìÑ View PDF
          </button>
          <button (click)="showContractDetailsModal = false" class="close-btn">‚úï</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="clause-details-grid">
          <div *ngFor="let clauseKey of CLAUSE_KEYS" class="clause-detail">
            <h4>{{ clauseKey }}</h4>
            <p [innerHTML]="highlightText(selectedContractForDetails.clauses[clauseKey] || '')"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Raw Diff Modal -->
  <div *ngIf="showRawDiffModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>Raw Wording Contrast</h3>
        <button (click)="showRawDiffModal = false" class="close-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="diff-grid">
          <div *ngFor="let i of [0]" class="diff-section">
            <div *ngIf="pickedContracts[i] && pickedContracts[i+1]">
              <h4>{{ pickedContracts[i].id }} vs {{ pickedContracts[i+1].id }}</h4>
              <div *ngFor="let clauseKey of CLAUSE_KEYS" class="diff-clause">
                <h5>{{ clauseKey }}</h5>
                <div class="diff-content">
                  <span *ngFor="let word of diffStrings(
                    pickedContracts[i].clauses[clauseKey] || '', 
                    pickedContracts[i+1].clauses[clauseKey] || ''
                  )" [innerHTML]="word + ' '"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Comparison Loading Modal -->
  <div *ngIf="showComparisonModal && isLoadingComparison" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ö° Generating Comparison</h3>
      </div>
      <div class="modal-body">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Analyzing contracts and generating comparison...</p>
          <p class="help-text">This may take a few moments depending on the number of contracts and clauses selected.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Clause Text Review Modal -->
  <div *ngIf="showClauseTextModal && selectedClauseForReview" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>üìã {{ selectedClauseForReview.clause_type }} - Clause Comparison</h3>
        <button (click)="closeClauseTextModal()" class="close-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="clause-comparison-container">
          <!-- Fixed Header Section -->
          <div class="clause-modal-fixed-header">
            <div class="comparison-metrics">
              <span class="badge" [ngClass]="getSimilarityBadgeClass(selectedClauseForReview.similarity_score * 100)">
                {{ (selectedClauseForReview.similarity_score * 100).toFixed(0) }}% Match
              </span>
              <span *ngIf="selectedClauseForReview.risks && selectedClauseForReview.risks.length > 0"
                    class="badge badge-danger">
                {{ selectedClauseForReview.risks.length }} Risk{{ selectedClauseForReview.risks.length > 1 ? 's' : '' }}
              </span>
            </div>

            <div *ngIf="selectedClauseForReview.summary" class="clause-summary-modal">
              <strong>Summary:</strong>
              <p>{{ selectedClauseForReview.summary }}</p>
            </div>
          </div>

          <!-- Scrollable Content Section -->
          <div class="clause-modal-scrollable-content">
          <div class="clause-text-side-by-side">
            <div class="clause-text-column">
              <h4>Standard Contract</h4>
              <div class="clause-text-box">
                <p *ngIf="selectedClauseForReview.standard_clause_text">
                  {{ selectedClauseForReview.standard_clause_text }}
                </p>
                <p *ngIf="!selectedClauseForReview.standard_clause_text" class="no-clause-text">
                  No clause text available
                </p>
              </div>
            </div>
            <div class="clause-text-column">
              <h4>{{ getContractTitle(selectedContractIdForReview) }}</h4>
              <div class="clause-text-box">
                <p *ngIf="selectedClauseForReview.compared_clause_text">
                  {{ selectedClauseForReview.compared_clause_text }}
                </p>
                <p *ngIf="!selectedClauseForReview.compared_clause_text" class="no-clause-text">
                  No clause text available
                </p>
              </div>
            </div>
          </div>

          <div *ngIf="selectedClauseForReview.key_differences && selectedClauseForReview.key_differences.length > 0" 
               class="differences-section">
            <h4>Key Differences</h4>
            <ul>
              <li *ngFor="let diff of selectedClauseForReview.key_differences">{{ diff }}</li>
            </ul>
          </div>

          <div *ngIf="selectedClauseForReview.risks && selectedClauseForReview.risks.length > 0"
               class="risks-section">
            <h4>Identified Risks</h4>
            <ul>
              <li *ngFor="let risk of selectedClauseForReview.risks" class="risk-item">{{ risk }}</li>
            </ul>
          </div>
          </div>
          <!-- End Scrollable Content Section -->
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeClauseTextModal()" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>
</div>